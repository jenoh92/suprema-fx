<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>í™˜ìœ¨ ì¡°íšŒ (í•œêµ­ì€í–‰ ECOS Â· ë§¤ë§¤ê¸°ì¤€ìœ¨ ê¸°ì¤€)</title>

<!-- jQuery & Chart.js -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== ì „ì²´ ë ˆì´ì•„ì›ƒ ===== */
body {
  font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
  background: #f7f7f7;
  margin: 0;
  padding: 0;
  color: #333;
}

/* ===== ìƒë‹¨ í—¤ë” ===== */
.header {
  display: flex;
  align-items: center;
  padding: 18px 28px;
  background: #ffffff;
  border-bottom: 1px solid #eee;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  gap: 12px;
}

.header img {
  height: 30px;
  display: block;
}

.header-title {
  font-size: 20px;
  font-weight: 700;
  color: #A12A44; /* Infinite Burgundy */
}

/* ===== ì»¨í…Œì´ë„ˆ ===== */
.container{
  padding: 18px 22px 28px;
}

/* ===== ìƒë‹¨ ì¡°íšŒ ì¹´ë“œ ===== */
.card {
  background: #fff;
  border-radius: 14px;
  padding: 18px 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

/* ìƒë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ */
.controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}

.controls-left{
  display:flex;
  align-items:center;
  gap: 10px;
  flex-wrap: wrap;
}

#dateInput {
  padding: 8px 10px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 8px;
  background: #fff;
}

button {
  background: #A12A44; /* Infinite Burgundy */
  color: #fff;
  border: none;
  padding: 9px 14px;
  font-size: 14px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.15s;
}
button:hover { background: #8B233A; }

.info {
  font-size: 12px;
  color: #666;
  margin-top: 10px;
  text-align: right;
}
.error {
  color: #d00;
  font-weight: bold;
  margin-top: 10px;
}

/* ===== 2ì—´ ë ˆì´ì•„ì›ƒ (í…Œì´ë¸”/ê·¸ë˜í”„ í•œ í™”ë©´) ===== */
.grid {
  margin-top: 16px;
  display: grid;
  grid-template-columns: 1.25fr 1fr;
  gap: 16px;
}

@media (max-width: 1100px){
  .grid{ grid-template-columns: 1fr; }
}

/* ===== í…Œì´ë¸” ===== */
.table-title, .chart-title{
  margin: 0 0 10px;
  font-size: 15px;
  font-weight: 700;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  table-layout: fixed;
}

th {
  background: #F4E6EA; /* ë²„ê±´ë”” ì—°í†¤ */
  color: #A12A44;
  font-weight: 700;
  padding: 12px 10px;
  border-bottom: 2px solid #ddd;
  text-align: center;
  font-size: 13px;
}

td {
  padding: 11px 10px;
  border-bottom: 1px solid #eee;
  text-align: center; /* âœ… ê°€ìš´ë° ì •ë ¬ */
  font-size: 13px;
}

tbody tr:hover { background: #fafafa; }

/* ===== ê·¸ë˜í”„ ì˜ì—­ ===== */
.chart-head{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  flex-wrap: wrap;
}

select {
  padding: 7px 10px;
  border-radius: 8px;
  border: 1px solid #aaa;
  font-size: 14px;
  background: #fff;
}

/* âœ… ì™¼ìª½ ì¹´ë“œ ë†’ì´ì— ë§ì¶”ë„ë¡: ê·¸ë˜í”„ ìº”ë²„ìŠ¤ ë†’ì´ë¥¼ ê³ ì • */
.chart-box{
  margin-top: 8px;
  border-radius: 14px;
  background:#fff;
  padding: 10px 10px 6px;
  box-shadow: inset 0 0 0 1px #eee;
}

#rateChart {
  width: 100%;
  height: 360px;  /* í•„ìš”í•˜ë©´ 330~420 ì‚¬ì´ë¡œ ì¡°ì ˆ */
}
</style>
</head>

<body>
  <div class="header">
    <img src="Suprema_logo_basic.jpg" alt="Suprema Logo" />
    <div class="header-title">í™˜ìœ¨ ì¡°íšŒ</div>
  </div>

  <div class="container">
    <!-- ìƒë‹¨ ì¡°íšŒ ì¹´ë“œ -->
    <div class="card">
      <div class="controls">
        <div class="controls-left">
          <label>ì¡°íšŒì¼:
            <input type="date" id="dateInput" />
          </label>
          <button id="btnSearch">ì¡°íšŒ</button>
          <button id="btnCsv">CSV ë‹¤ìš´ë¡œë“œ</button>
        </div>
        <div id="subInfo" class="info"></div>
      </div>
      <div id="msg"></div>
    </div>

    <!-- í…Œì´ë¸” + ê·¸ë˜í”„ -->
    <div class="grid">
      <!-- í…Œì´ë¸” ì¹´ë“œ -->
      <div class="card">
        <div class="table-title">í™˜ìœ¨ í…Œì´ë¸”</div>
        <table>
          <thead>
            <tr>
              <th style="width: 26%;">í†µí™”</th>
              <th style="width: 18%;">ìµœì´ˆ ê³ ì‹œí™˜ìœ¨ (ì›)</th>
              <th style="width: 20%;">ì—°ì´ˆ~ì¡°íšŒì¼ í‰ê·  (ì›)</th>
              <th style="width: 18%;">ì „ì›” í‰ê·  (ì›)</th>
              <th style="width: 18%;">ìµœê·¼ 3ê°œì›” í‰ê·  (ì›)</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <!-- ê·¸ë˜í”„ ì¹´ë“œ -->
      <div class="card">
        <div class="chart-head">
          <div class="chart-title">í™˜ìœ¨ ë³€ë™ ì¶”ì´ (ìµœê·¼ 3ê°œì›”)</div>
          <label>í†µí™”:
            <select id="chartCurrency"></select>
          </label>
        </div>

        <div class="chart-box">
          <canvas id="rateChart"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
// ===== ë°±ì—”ë“œ ì›¹ì•± ì£¼ì†Œ =====
const BACKEND =
  "https://script.google.com/macros/s/AKfycbwy_VgzLTGEoc_Cww9lQ4_44GZHsWRbEKJvYN6SByvXS13qV0LPEYgPjuSWuiJKTEZm/exec";

// ===== ECOS í†µí™” ëª©ë¡ =====
const CURRENCIES = [
  { key: "ë¯¸êµ­ë‹¬ëŸ¬", label: "USD (ë¯¸êµ­ ë‹¬ëŸ¬)" },
  { key: "ìœ ë¡œ", label: "EUR (ìœ ë¡œ)" },
  { key: "ì¼ë³¸ì—”(100ì—”)", label: "JPY (ì¼ë³¸ì—”Â·100ì—”)" },
  { key: "ì˜êµ­íŒŒìš´ë“œ", label: "GBP (ì˜êµ­ íŒŒìš´ë“œ)" },
  { key: "ë©•ì‹œì½”", label: "MXN (ë©•ì‹œì½” í˜ì†Œ)" },
  { key: "ì•„ëì—ë¯¸ë¦¬íŠ¸ë””ë¥´í•¨", label: "AED (ì•„ëì—ë¯¸ë¦¬íŠ¸ ë””ë¥´í•¨)" },
  { key: "ì¸ë„ë£¨í”¼", label: "INR (ì¸ë„ ë£¨í”¼)" }
];

// ===== ìˆ«ì í¬ë§· =====
function formatNumber(x) {
  if (x == null) return "-";
  const n = Number(x);
  return isNaN(n) ? "-" : n.toLocaleString("ko-KR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function parseNumber(x) {
  if (x == null) return null;
  const n = Number(String(x).replace(/,/g, ""));
  return isNaN(n) ? null : n;
}

// ===== ë‚ ì§œ ìœ í‹¸ =====
function ymdFromDate(d) {
  return `${d.getFullYear()}${("0" + (d.getMonth() + 1)).slice(-2)}${("0" + d.getDate()).slice(-2)}`;
}
function dateFromYmd(ymd) {
  return new Date(ymd.slice(0,4), Number(ymd.slice(4,6)) - 1, ymd.slice(6,8));
}
function getYearStartYmd(ymd) {
  return ymd.slice(0,4) + "0102"; // ECOS ì—°ì´ˆ ë°ì´í„° ì‹œì‘(1/2)
}

// ===== í‰ê·  ê³„ì‚° (ë‚ ì§œë³„ ìµœì´ˆê°’ë§Œ) =====
function calcAverage(rows, key, start, end) {
  const map = {};
  rows.forEach(r => {
    if (!String(r.ITEM_NAME1 || "").includes(key)) return;
    const t = String(r.TIME || "");
    if (!t || t < start || t > end) return;

    const v = parseNumber(r.DATA_VALUE);
    if (v == null) return;

    if (!(t in map)) map[t] = v;
  });

  const vals = Object.values(map);
  if (!vals.length) return null;
  return vals.reduce((a,b)=>a+b,0) / vals.length;
}

// ===== ì¡°íšŒì¼(ë”± ê·¸ë‚ ) ìµœì´ˆê°’ =====
function getRateOnDate(rows, key, ymd) {
  let v = null;
  rows.forEach(r => {
    if (!String(r.ITEM_NAME1 || "").includes(key)) return;
    if (String(r.TIME || "") !== ymd) return;
    if (v == null) v = parseNumber(r.DATA_VALUE);
  });
  return v;
}

// ===== ê·¸ë˜í”„ =====
function updateChart(rows, queryYmd, label) {
  const cfg = CURRENCIES.find(c => c.label === label) || CURRENCIES[0];
  const key = cfg.key;

  const qd = dateFromYmd(queryYmd);
  const threeStart = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth() - 3, 1));

  const map = {};
  rows.forEach(r => {
    if (!String(r.ITEM_NAME1 || "").includes(key)) return;
    const t = String(r.TIME || "");
    if (!t || t < threeStart || t > queryYmd) return;

    const v = parseNumber(r.DATA_VALUE);
    if (v != null && !(t in map)) map[t] = v;
  });

  const dates = Object.keys(map).sort();
  const labels = dates.map(d => `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}`);
  const values = dates.map(d => map[d]);

  const ctx = document.getElementById("rateChart").getContext("2d");
  if (window._chartObj) window._chartObj.destroy();

  window._chartObj = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        data: values,
        borderColor: "#78787A",   // Classy Gray
        borderWidth: 2,
        pointRadius: 0,
        fill: false,
        tension: 0.15
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,  // âœ… CSS height ì ìš©
      plugins: { legend: { display: false } },
      scales: {
        x: {
          ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
          grid: { display: true }
        },
        y: {
          grid: { display: true }
        }
      }
    }
  });
}

// ===== ì¡°íšŒ ì‹¤í–‰ =====
function search() {
  $("#msg").removeClass("error").text("ì¡°íšŒì¤‘...");
  $("#tbody").empty();

  const d = $("#dateInput").val();
  if (!d) {
    $("#msg").addClass("error").text("ì¡°íšŒì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  const ymd = d.replace(/-/g,"");
  const qd = dateFromYmd(ymd);

  const yearStart = getYearStartYmd(ymd);
  const prevFirst = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth() - 1, 1));
  const prevLast  = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth(), 0));
  const threeStart = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth() - 3, 1));

  // ë¬¸ìì—´ ë¹„êµë¡œ minStart (ì—°ì´ˆ vs 3ê°œì›” ì‹œì‘)
  const minStart = (yearStart < threeStart ? yearStart : threeStart);

  const url = `${BACKEND}?start=${minStart}&end=${ymd}&callback=?`;

  $.ajax({
    url,
    dataType: "jsonp",
    success: function (data) {
      $("#msg").text("");

      const rows = data?.StatisticSearch?.row || [];
      window._lastRows = rows;

      if (!rows.length) {
        $("#msg").addClass("error").text("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ì£¼ë§/ê³µíœ´ì¼ ë“±)");
        $("#subInfo").text(`ì¡°íšŒ ê¸°ì¤€ì¼: ${d}`);
        return;
      }

      $("#subInfo").text(`ì¡°íšŒ ê¸°ì¤€ì¼: ${d}`);
      $("#tbody").empty();

      CURRENCIES.forEach(c => {
        const fr   = getRateOnDate(rows, c.key, ymd);
        const yavg = calcAverage(rows, c.key, yearStart, ymd);
        const pavg = calcAverage(rows, c.key, prevFirst, prevLast);
        const m3avg= calcAverage(rows, c.key, threeStart, prevLast);

        $("#tbody").append(`
          <tr>
            <td>${c.label}</td>
            <td>${formatNumber(fr)}</td>
            <td>${formatNumber(yavg)}</td>
            <td>${formatNumber(pavg)}</td>
            <td>${formatNumber(m3avg)}</td>
          </tr>
        `);
      });

      // ê·¸ë˜í”„
      updateChart(rows, ymd, $("#chartCurrency").val());
    },
    error: function(){
      $("#msg").addClass("error").text("ì¡°íšŒ ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬/ë°±ì—”ë“œ í™•ì¸)");
    }
  });
}

// ===== CSV ë‹¤ìš´ë¡œë“œ (ğŸ”¥ ì—‘ì…€ ì•ˆê¹¨ì§€ê²Œ: UTF-8 BOM + CRLF) =====
function downloadCSV(){
  const BOM = "\uFEFF";           // âœ… Excel UTF-8 ì¸ì‹ìš© BOM
  const CRLF = "\r\n";            // âœ… Excel ì¤„ë°”ê¿ˆ

  let lines = ["í†µí™”,ìµœì´ˆ ê³ ì‹œí™˜ìœ¨,ì—°ì´ˆ~ì¡°íšŒì¼ í‰ê· ,ì „ì›” í‰ê· ,ìµœê·¼ 3ê°œì›” í‰ê· "];

  $("#tbody tr").each(function(){
    const tds = $(this).find("td");
    const cols = [];
    tds.each(function(){
      // ì‰¼í‘œ/ë”°ì˜´í‘œ ëŒ€ë¹„: CSV í‘œì¤€ ë”°ì˜´í‘œ ì²˜ë¦¬
      let text = $(this).text().replace(/\s+/g," ").trim();
      text = '"' + text.replace(/"/g,'""') + '"';
      cols.push(text);
    });
    lines.push(cols.join(","));
  });

  const csv = BOM + lines.join(CRLF);
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "í™˜ìœ¨ì¡°íšŒ.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===== ì´ˆê¸° ì‹¤í–‰ =====
$(function () {
  const t = new Date();
  $("#dateInput").val(
    `${t.getFullYear()}-${("0" + (t.getMonth() + 1)).slice(-2)}-${("0" + t.getDate()).slice(-2)}`
  );

  CURRENCIES.forEach(c => {
    $("#chartCurrency").append(`<option value="${c.label}">${c.label}</option>`);
  });

  $("#btnSearch").on("click", search);
  $("#btnCsv").on("click", downloadCSV);

  $("#chartCurrency").on("change", function () {
    if (!window._lastRows) return;
    const d = $("#dateInput").val().replace(/-/g, "");
    updateChart(window._lastRows, d, $(this).val());
  });

  // âœ… ì²« í™”ë©´ ìë™ ì¡°íšŒ
  search();
});
</script>
</body>
</html>
