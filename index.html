<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>환율 조회 (한국은행 ECOS · 매매기준율)</title>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: 'Pretendard','Noto Sans KR',sans-serif;
  background:#f7f7f7;
  margin:0;
  color:#333;
}

/* ===== 헤더 ===== */
.header{
  display:flex;
  align-items:center;
  padding:20px 32px;
  background:#fff;
  border-bottom:1px solid #eee;
}
.header img{height:34px;margin-right:12px;}
.header-title{font-size:22px;font-weight:600;color:#A12A44}

/* ===== 공통 카드 ===== */
.card{
  background:#fff;
  border-radius:14px;
  padding:20px 24px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

/* ===== 상단 조회 ===== */
.top-bar{
  margin:20px;
  display:flex;
  align-items:center;
  gap:8px;
}
button{
  background:#A12A44;
  color:#fff;
  border:none;
  padding:7px 14px;
  border-radius:6px;
  cursor:pointer;
}
button:hover{background:#8B233A}

/* ===== 레이아웃 ===== */
.main{
  display:grid;
  grid-template-columns: 1.2fr 1fr;
  gap:20px;
  padding:0 20px 20px;
}

/* ===== 테이블 ===== */
table{
  width:100%;
  border-collapse:collapse;
}
th{
  background:#F4E6EA;
  color:#A12A44;
  padding:12px;
  text-align:center;
}
td{
  padding:11px;
  text-align:center;
  border-bottom:1px solid #eee;
}
.up{color:#C62828;font-weight:600;}
.down{color:#1565C0;font-weight:600;}

/* ===== 그래프 ===== */
#rateChart{height:420px !important;}
</style>
</head>

<body>

<div class="header">
  <img src="Suprema_logo_basic.jpg">
  <div class="header-title">환율 조회</div>
</div>

<div class="card top-bar">
  <label>조회일:
    <input type="date" id="dateInput">
  </label>
  <button id="btnSearch">조회</button>
  <button id="btnCsv">엑셀 다운로드</button>
</div>

<div class="main">

  <!-- ===== 테이블 ===== -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>통화</th>
          <th>최초 고시환율</th>
          <th>연초 평균</th>
          <th>전월 평균</th>
          <th>최근 3개월 평균</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- ===== 그래프 ===== -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <strong>환율 변동 추이 (최근 3개월)</strong>
      <select id="chartCurrency"></select>
    </div>
    <canvas id="rateChart"></canvas>
  </div>

</div>

<script>
const BACKEND="https://script.google.com/macros/s/AKfycbwy_VgzLTGEoc_Cww9lQ4_44GZHsWRbEKJvYN6SByvXS13qV0LPEYgPjuSWuiJKTEZm/exec";

const CURRENCIES=[
 {key:"미국달러",label:"USD (미국 달러)"},
 {key:"멕시코",label:"MXN (멕시코 페소)"},
 {key:"영국파운드",label:"GBP (영국 파운드)"},
 {key:"유로",label:"EUR (유로)"},
 {key:"아랍에미리트디르함",label:"AED (디르함)"},
 {key:"일본엔(100엔)",label:"JPY (100엔)"},
 {key:"인도루피",label:"INR (루피)"}
];

const fmt=n=>n==null?"-":Number(n).toLocaleString("ko-KR",{minimumFractionDigits:2});
const num=x=>Number(String(x).replace(/,/g,""));
const ymd=d=>`${d.getFullYear()}${("0"+(d.getMonth()+1)).slice(-2)}${("0"+d.getDate()).slice(-2)}`;
const fromYmd=s=>new Date(s.slice(0,4),s.slice(4,6)-1,s.slice(6,8));

let chart;

function search(){
 const d=$("#dateInput").val().replace(/-/g,"");
 const qd=fromYmd(d);
 const ys=d.slice(0,4)+"0102";
 const pm1=ymd(new Date(qd.getFullYear(),qd.getMonth()-1,1));
 const pm2=ymd(new Date(qd.getFullYear(),qd.getMonth(),0));
 const m3=ymd(new Date(qd.getFullYear(),qd.getMonth()-3,1));
 const start=ys<m3?ys:m3;

 $.getJSON(`${BACKEND}?start=${start}&end=${d}&callback=?`,data=>{
   const rows=data.StatisticSearch.row;
   window._rows=rows;
   $("#tbody").empty();

   CURRENCIES.forEach(c=>{
     const today=rows.find(r=>r.TIME===d && r.ITEM_NAME1.includes(c.key));
     const prev=rows.find(r=>r.TIME===pm2 && r.ITEM_NAME1.includes(c.key));
     const diff=prev&&today?num(today.DATA_VALUE)-num(prev.DATA_VALUE):0;

     $("#tbody").append(`
      <tr>
       <td>${c.label}</td>
       <td class="${diff>0?'up':'down'}">${fmt(today?.DATA_VALUE)}</td>
       <td>${fmt(avg(rows,c.key,ys,d))}</td>
       <td>${fmt(avg(rows,c.key,pm1,pm2))}</td>
       <td>${fmt(avg(rows,c.key,m3,pm2))}</td>
      </tr>
     `);
   });

   drawChart(d,$("#chartCurrency").val());
 });
}

function avg(rows,key,s,e){
 const v=rows.filter(r=>r.ITEM_NAME1.includes(key)&&r.TIME>=s&&r.TIME<=e)
 .map(r=>num(r.DATA_VALUE));
 return v.length?v.reduce((a,b)=>a+b,0)/v.length:null;
}

function drawChart(d,label){
 const cfg=CURRENCIES.find(c=>c.label===label);
 const m3=ymd(new Date(fromYmd(d).getFullYear(),fromYmd(d).getMonth()-3,1));
 const map={};

 window._rows.forEach(r=>{
  if(r.ITEM_NAME1.includes(cfg.key)&&r.TIME>=m3&&r.TIME<=d)
   map[r.TIME]=num(r.DATA_VALUE);
 });

 const labels=Object.keys(map).sort();
 const values=labels.map(k=>map[k]);

 if(chart)chart.destroy();
 chart=new Chart(rateChart,{
  type:"line",
  data:{labels, datasets:[{
    data:values,
    borderColor:"#78787A",
    borderWidth:2,
    pointRadius:0
  }]},
  options:{
    plugins:{legend:{display:false}},
    scales:{y:{beginAtZero:false, grace:'3%'}}
  }
 });
}

// ===== CSV (엑셀 한글 완벽 대응) =====
function downloadCSV() {
  const CRLF = "\r\n";
  const SEP = "\t"; // ✅ 탭으로 분리 (엑셀에서 표로 잘 열림)

  let lines = [];
  lines.push(["통화","최초 고시환율","연초 평균","전월 평균","최근 3개월 평균"].join(SEP));

  $("#tbody tr").each(function(){
    const cols = [];
    $(this).find("td").each(function(){
      cols.push($(this).text().replace(/\t/g," "));
    });
    lines.push(cols.join(SEP));
  });

  const text = lines.join(CRLF);

  // ✅ UTF-16LE + BOM (한글 완벽)
  const buf = new ArrayBuffer(2 + text.length * 2);
  const view = new DataView(buf);
  view.setUint8(0, 0xFF); view.setUint8(1, 0xFE);
  for (let i=0;i<text.length;i++) view.setUint16(2+i*2, text.charCodeAt(i), true);

  const blob = new Blob([buf], { type: "text/tab-separated-values;charset=utf-16le;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "환율조회.tsv";   // ✅ 확장자 tsv
  a.click();
}


$(function(){
 const t=new Date();
 $("#dateInput").val(`${t.getFullYear()}-${("0"+(t.getMonth()+1)).slice(-2)}-${("0"+t.getDate()).slice(-2)}`);
 CURRENCIES.forEach(c=>$("#chartCurrency").append(`<option>${c.label}</option>`));
 $("#btnSearch").click(search);
 $("#btnCsv").click(downloadCSV);
 $("#chartCurrency").change(()=>drawChart($("#dateInput").val().replace(/-/g,""),$("#chartCurrency").val()));
 search();
});
</script>

</body>
</html>


