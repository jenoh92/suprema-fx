<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>í™˜ìœ¨ ì¡°íšŒ (í•œêµ­ì€í–‰ ECOS Â· ë§¤ë§¤ê¸°ì¤€ìœ¨ ê¸°ì¤€)</title>

<!-- jQuery & Chart.js -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== ì „ì²´ ë ˆì´ì•„ì›ƒ ===== */
body {
  font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
  background: #f7f7f7;
  margin: 0;
  padding: 0;
  color: #333;
}

/* ===== ìƒë‹¨ í—¤ë” ===== */
.header {
  display: flex;
  align-items: center;
  padding: 22px 32px;
  background: #ffffff;
  border-bottom: 1px solid #eee;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

.header img {
  height: 34px;
  margin-right: 14px;
}

.header-title {
  font-size: 22px;
  font-weight: 600;
  color: #A12A44; /* Infinite Burgundy */
  margin-left: 8px;
}

/* ===== ì¡°íšŒ ì¹´ë“œ ===== */
.card {
  background: #fff;
  border-radius: 14px;
  padding: 22px 28px;
  margin: 24px auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

/* ===== ì¡°íšŒ ì˜ì—­ ===== */
#dateInput {
  padding: 6px 10px;
  font-size: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

button {
  background: #A12A44; /* Infinite Burgundy */
  color: #fff;
  border: none;
  padding: 8px 16px;
  font-size: 15px;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.15s;
  margin-left: 6px;
}

button:hover {
  background: #8B233A; /* ë” ì§™ì€ ë²„ê±´ë”” */
}

/* ===== í…Œì´ë¸” ===== */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  background: #fff;
}

th {
  background: #F4E6EA; /* ë²„ê±´ë”” ì—°í†¤ */
  color: #A12A44;
  font-weight: 600;
  padding: 14px 0;
  border-bottom: 2px solid #ddd;
}

td {
  padding: 12px 6px;
  border-bottom: 1px solid #eee;
}

tbody tr:hover {
  background: #fafafa;
}

/* ===== ì•ˆë‚´ë¬¸êµ¬ ===== */
.info {
  font-size: 13px;
  color: #555;
  margin-top: 10px;
}

.error {
  color: #d00;
  font-weight: bold;
  margin-top: 12px;
}

/* ===== ê·¸ë˜í”„ ì˜ì—­ ===== */
#chartArea {
  margin-top: 36px;
}

#chartContainer {
  max-width: 900px;
  margin: 0 auto;
}

#rateChart {
  background: #ffffff;
  border-radius: 14px;
  padding: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

select {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #aaa;
  font-size: 15px;
}
</style>
</head>

<body>

<!-- ===== ìƒë‹¨ í—¤ë” ===== -->
<div class="header">
  <img src="Suprema_logo_basic.jpg" alt="Suprema Logo">
  <div class="header-title">í™˜ìœ¨ ì¡°íšŒ</div>
</div>

<!-- ===== ì¡°íšŒ ì˜ì—­ ===== -->
<div class="card">
  <label>ì¡°íšŒì¼:
    <input type="date" id="dateInput">
  </label>
  <button id="btnSearch">ì¡°íšŒ</button>
  <button id="btnCsv">CSV ë‹¤ìš´ë¡œë“œ</button>

  <div id="msg"></div>
  <div id="subInfo" class="info"></div>
</div>

<!-- ===== ê²°ê³¼ í…Œì´ë¸” ===== -->
<div class="card">
<table>
  <thead>
    <tr>
      <th>í†µí™”</th>
      <th>ìµœì´ˆ ê³ ì‹œí™˜ìœ¨ (ì›)</th>
      <th>ì—°ì´ˆ~ì¡°íšŒì¼ í‰ê·  (ì›)</th>
      <th>ì „ì›” í‰ê·  (ì›)</th>
      <th>ìµœê·¼ 3ê°œì›” í‰ê·  (ì›)</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>
</div>

<!-- ===== ê·¸ë˜í”„ ===== -->
<div class="card" id="chartArea">
  <h3>í™˜ìœ¨ ë³€ë™ ì¶”ì´ (ìµœê·¼ 3ê°œì›”)</h3>
  <label>í†µí™”:
    <select id="chartCurrency"></select>
  </label>

  <div id="chartContainer">
    <canvas id="rateChart" height="360"></canvas>
  </div>
</div>

<script>
// ë°±ì—”ë“œ ì›¹ì•± ì£¼ì†Œ
const BACKEND =
  "https://script.google.com/macros/s/AKfycbwy_VgzLTGEoc_Cww9lQ4_44GZHsWRbEKJvYN6SByvXS13qV0LPEYgPjuSWuiJKTEZm/exec";

// ECOS í†µí™” ëª©ë¡
const CURRENCIES = [
  { key: "ë¯¸êµ­ë‹¬ëŸ¬", label: "USD (ë¯¸êµ­ ë‹¬ëŸ¬)" },
  { key: "ë©•ì‹œì½”", label: "MXN (ë©•ì‹œì½” í˜ì†Œ)" },
  { key: "ì˜êµ­íŒŒìš´ë“œ", label: "GBP (ì˜êµ­ íŒŒìš´ë“œ)" },
  { key: "ìœ ë¡œ", label: "EUR (ìœ ë¡œ)" },
  { key: "ì•„ëì—ë¯¸ë¦¬íŠ¸ë””ë¥´í•¨", label: "AED (ì•„ëì—ë¯¸ë¦¬íŠ¸ ë””ë¥´í•¨)" },
  { key: "ì¼ë³¸ì—”(100ì—”)", label: "JPY (ì¼ë³¸ì—”Â·100ì—”)" },
  { key: "ì¸ë„ë£¨í”¼", label: "INR (ì¸ë„ ë£¨í”¼)" }
];

// ìˆ«ì í¬ë§·
function formatNumber(x) {
  if (x == null) return "-";
  const n = Number(x);
  return isNaN(n)
    ? "-"
    : n.toLocaleString("ko-KR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// ë¬¸ìì—´ â†’ ìˆ«ì
function parseNumber(x) {
  const n = Number(String(x).replace(/,/g, ""));
  return isNaN(n) ? null : n;
}

// ë‚ ì§œ YYYYMMDD ë³€í™˜
function ymdFromDate(d) {
  return `${d.getFullYear()}${("0" + (d.getMonth() + 1)).slice(-2)}${("0" + d.getDate()).slice(-2)}`;
}

function dateFromYmd(ymd) {
  return new Date(ymd.slice(0, 4), ymd.slice(4, 6) - 1, ymd.slice(6, 8));
}

function getYearStartYmd(ymd) {
  return ymd.slice(0, 4) + "0102"; // ECOS ë°ì´í„° ê¸°ì¤€
}

// ë‚ ì§œ ë²”ìœ„ í‰ê·  ê³„ì‚°
function calcAverage(rows, key, start, end) {
  const map = {};
  rows.forEach(r => {
    if (!String(r.ITEM_NAME1).includes(key)) return;
    const t = String(r.TIME);
    if (t < start || t > end) return;
    const v = parseNumber(r.DATA_VALUE);
    if (v == null) return;
    if (!(t in map)) map[t] = v;
  });

  const vals = Object.values(map);
  if (!vals.length) return null;
  return vals.reduce((a, b) => a + b, 0) / vals.length;
}

// ì¡°íšŒì¼ ì²« í™˜ìœ¨
function getRateOnDate(rows, key, ymd) {
  let v = null;
  rows.forEach(r => {
    if (!String(r.ITEM_NAME1).includes(key)) return;
    if (String(r.TIME) !== ymd) return;
    if (v == null) v = parseNumber(r.DATA_VALUE);
  });
  return v;
}

// ===== ê·¸ë˜í”„ ê·¸ë¦¬ê¸° =====
function updateChart(rows, queryYmd, label) {
  const cfg = CURRENCIES.find(c => c.label === label);
  if (!cfg) return;
  const key = cfg.key;

  const qd = dateFromYmd(queryYmd);
  const threeStart = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth() - 3, 1));

  const map = {};
  rows.forEach(r => {
    if (!String(r.ITEM_NAME1).includes(key)) return;
    const t = String(r.TIME);
    if (t < threeStart || t > queryYmd) return;
    const v = parseNumber(r.DATA_VALUE);
    if (v != null && !(t in map)) map[t] = v;
  });

  const dates = Object.keys(map).sort();
  const labels = dates.map(d => `${d.slice(0, 4)}-${d.slice(4, 6)}-${d.slice(6, 8)}`);
  const values = dates.map(d => map[d]);

  const ctx = document.getElementById("rateChart").getContext("2d");
  if (window._chartObj) window._chartObj.destroy();

  window._chartObj = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label,
          data: values,
          borderColor: "#78787A", /* Classy Gray */
          borderWidth: 2,
          pointRadius: 0,
          fill: false
        }
      ]
    },
    options: {
      plugins: { legend: { display: false } }
    }
  });
}

// ===== ì¡°íšŒ ì‹¤í–‰ =====
function search() {
  $("#msg").text("ì¡°íšŒì¤‘...");
  $("#tbody").empty();

  const d = $("#dateInput").val();
  if (!d) return alert("ì¡°íšŒì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  const ymd = d.replace(/-/g, "");

  const qd = dateFromYmd(ymd);
  const yearStart = getYearStartYmd(ymd);

  const prevFirst = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth() - 1, 1));
  const prevLast = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth(), 0));

  const threeStart = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth() - 3, 1));

  /* ğŸ”¥ ì¤‘ìš”! ë¬¸ìì—´ ë‚ ì§œ ë¹„êµë¡œ minStart ì„¤ì • */
  const minStart = (yearStart < threeStart ? yearStart : threeStart);

  const url = `${BACKEND}?start=${minStart}&end=${ymd}&callback=?`;

  $.ajax({
    url,
    dataType: "jsonp",
    success: function (data) {
      $("#msg").text("");

      const rows = data?.StatisticSearch?.row || [];
      window._lastRows = rows;

      $("#tbody").empty();

      CURRENCIES.forEach(c => {
        const fr = getRateOnDate(rows, c.key, ymd);
        const yavg = calcAverage(rows, c.key, yearStart, ymd);
        const pavg = calcAverage(rows, c.key, prevFirst, prevLast);
        const m3avg = calcAverage(rows, c.key, threeStart, prevLast);

        $("#tbody").append(`
          <tr>
            <td>${c.label}</td>
            <td>${formatNumber(fr)}</td>
            <td>${formatNumber(yavg)}</td>
            <td>${formatNumber(pavg)}</td>
            <td>${formatNumber(m3avg)}</td>
          </tr>
        `);
      });

      updateChart(rows, ymd, $("#chartCurrency").val());
    }
  });
}

// ===== CSV ë‹¤ìš´ë¡œë“œ =====
function downloadCSV() {
  let lines = ["í†µí™”,ìµœì´ˆ ê³ ì‹œí™˜ìœ¨,ì—°ì´ˆ~ì¡°íšŒì¼ í‰ê· ,ì „ì›” í‰ê· ,ìµœê·¼ 3ê°œì›” í‰ê· "];

  $("#tbody tr").each(function () {
    const tds = $(this).find("td");
    const arr = [];
    tds.each(function () {
      arr.push($(this).text().replace(/,/g, ""));
    });
    lines.push(arr.join(","));
  });

  const blob = new Blob([lines.join("\n")], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "í™˜ìœ¨ì¡°íšŒ.csv";
  document.body.appendChild(a);
  a.click();

  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===== ì´ˆê¸° ì‹¤í–‰ =====
$(function () {
  const t = new Date();
  $("#dateInput").val(
    `${t.getFullYear()}-${("0" + (t.getMonth() + 1)).slice(-2)}-${("0" + t.getDate()).slice(-2)}`
  );

  CURRENCIES.forEach(c =>
    $("#chartCurrency").append(`<option value="${c.label}">${c.label}</option>`)
  );

  $("#btnSearch").on("click", search);
  $("#btnCsv").on("click", downloadCSV);

  $("#chartCurrency").on("change", function () {
    if (!window._lastRows) return;
    const d = $("#dateInput").val().replace(/-/g, "");
    updateChart(window._lastRows, d, $(this).val());
  });
});
</script>

</body>
</html>
