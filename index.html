<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>í™˜ìœ¨ ì¡°íšŒ (í•œêµ­ì€í–‰ ECOS Â· ë§¤ë§¤ê¸°ì¤€ìœ¨ ê¸°ì¤€)</title>

<!-- jQuery & Chart.js -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== ì „ì²´ ë ˆì´ì•„ì›ƒ ===== */
body{
  font-family:'Pretendard','Noto Sans KR',sans-serif;
  background:#f7f7f7;
  margin:0;
  padding:0;
  color:#333;
}

/* ===== ìƒë‹¨ í—¤ë” ===== */
.header{
  display:flex;
  align-items:center;
  padding:18px 28px;
  background:#fff;
  border-bottom:1px solid #eee;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
}
.header img{ height:34px; margin-right:14px; }
.header-title{
  font-size:22px;
  font-weight:700;
  color:#A12A44; /* Suprema Burgundy */
  margin-left:8px;
}

/* ===== ì¹´ë“œ ===== */
.card{
  background:#fff;
  border-radius:14px;
  padding:18px 20px;
  margin:18px auto;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}

/* ===== ì¡°íšŒ ì˜ì—­ ===== */
.controls{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
#dateInput{
  padding:7px 10px;
  font-size:15px;
  border:1px solid #ccc;
  border-radius:8px;
}

button{
  background:#A12A44;
  color:#fff;
  border:none;
  padding:8px 16px;
  font-size:15px;
  border-radius:8px;
  cursor:pointer;
  transition:0.15s;
}
button:hover{ background:#8B233A; }

.info{ font-size:13px; color:#555; margin-top:10px; }
.error{ color:#d00; font-weight:bold; margin-top:12px; }

/* ===== í•œ í™”ë©´ ë ˆì´ì•„ì›ƒ: í…Œì´ë¸”(ì™¼ìª½) + ê·¸ë˜í”„(ì˜¤ë¥¸ìª½) ===== */
.content-row{
  display:flex;
  gap:18px;
  align-items:stretch;        /* ğŸ”¥ ë†’ì´ ìë™ ì¼ì¹˜ */
}
.table-card{ flex:1.1; }
.chart-card{
  flex:0.9;
  display:flex;
  flex-direction:column;
}
.chart-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:8px;
}
.chart-title{
  font-size:16px;
  font-weight:700;
  margin:0;
}
.chart-controls{
  display:flex;
  align-items:center;
  gap:8px;
  white-space:nowrap;
}
select{
  padding:6px 10px;
  border-radius:8px;
  border:1px solid #aaa;
  font-size:14px;
}

/* ê·¸ë˜í”„ê°€ ì¹´ë“œ ì „ì²´ ë†’ì´ë¥¼ ì±„ìš°ê²Œ */
#chartContainer{ flex:1; min-height:340px; }
#rateChart{
  background:#fff;
  border-radius:12px;
  width:100% !important;
  height:100% !important;
}

/* ===== í…Œì´ë¸” ===== */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  background:#fff;
}
th, td{
  padding:12px 8px;
  border-bottom:1px solid #eee;
  text-align:center;          /* âœ… ê¸€ì ê°€ìš´ë° ì •ë ¬ */
  vertical-align:middle;
}
th{
  background:#F4E6EA;
  color:#A12A44;
  font-weight:700;
  border-bottom:2px solid #ddd;
}
tbody tr:hover{ background:#fafafa; }

/* í†µí™” ì¹¸ë„ ê°€ìš´ë° ì •ë ¬(ê¸°ë³¸ td centerë¼ì„œ OK) */

/* ===== ì „ì¼ëŒ€ë¹„ í‘œì‹œ ===== */
.delta{
  display:inline-flex;
  align-items:center;
  gap:6px;
  margin-left:8px;
  font-size:12px;
  font-weight:700;
}
.delta.up{ color:#A12A44; }      /* ìƒìŠ¹: ë²„ê±´ë”” */
.delta.down{ color:#78787A; }    /* í•˜ë½: Classy Gray */
.delta.same{ color:#000; }       /* ë™ì¼: ë¸”ë™ */

.delta .badge{
  display:inline-block;
  padding:2px 6px;
  border-radius:999px;
  font-size:11px;
  font-weight:800;
  background:rgba(161,42,68,0.08);
}
.delta.down .badge{ background:rgba(120,120,122,0.12); }
.delta.same .badge{ background:rgba(0,0,0,0.08); }

/* ===== ë°˜ì‘í˜•(ì‘ì€ í™”ë©´ì€ ì„¸ë¡œë¡œ) ===== */
@media (max-width: 1100px){
  .content-row{ flex-direction:column; }
  #chartContainer{ min-height:320px; }
}
</style>
</head>

<body>

<div class="header">
  <img src="Suprema_logo_basic.jpg" alt="Suprema Logo">
  <div class="header-title">í™˜ìœ¨ ì¡°íšŒ</div>
</div>

<div class="card">
  <div class="controls">
    <label>ì¡°íšŒì¼:
      <input type="date" id="dateInput" />
    </label>
    <button id="btnSearch">ì¡°íšŒ</button>
    <button id="btnCsv">CSV ë‹¤ìš´ë¡œë“œ</button>
  </div>
  <div id="msg"></div>
  <div id="subInfo" class="info"></div>
</div>

<div class="content-row">
  <!-- ===== í…Œì´ë¸” ===== -->
  <div class="card table-card">
    <table>
      <thead>
        <tr>
          <th>í†µí™”</th>
          <th>ìµœì´ˆ ê³ ì‹œí™˜ìœ¨ (ì›)</th>
          <th>ì—°ì´ˆ~ì¡°íšŒì¼ í‰ê·  (ì›)</th>
          <th>ì „ì›” í‰ê·  (ì›)</th>
          <th>ìµœê·¼ 3ê°œì›” í‰ê·  (ì›)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- ===== ê·¸ë˜í”„ ===== -->
  <div class="card chart-card" id="chartArea">
    <div class="chart-head">
      <h3 class="chart-title">í™˜ìœ¨ ë³€ë™ ì¶”ì´ (ìµœê·¼ 3ê°œì›”)</h3>
      <div class="chart-controls">
        <span>í†µí™”:</span>
        <select id="chartCurrency"></select>
      </div>
    </div>
    <div id="chartContainer">
      <canvas id="rateChart"></canvas>
    </div>
  </div>
</div>

<script>
// ë°±ì—”ë“œ ì›¹ì•± ì£¼ì†Œ
const BACKEND =
  "https://script.google.com/macros/s/AKfycbwy_VgzLTGEoc_Cww9lQ4_44GZHsWRbEKJvYN6SByvXS13qV0LPEYgPjuSWuiJKTEZm/exec";

// í†µí™” ëª©ë¡(ì›í•˜ëŠ” ìˆœì„œ)
const CURRENCIES = [
  { key: "ë¯¸êµ­ë‹¬ëŸ¬", label: "USD (ë¯¸êµ­ ë‹¬ëŸ¬)" },
  { key: "ë©•ì‹œì½”", label: "MXN (ë©•ì‹œì½” í˜ì†Œ)" },
  { key: "ì˜êµ­íŒŒìš´ë“œ", label: "GBP (ì˜êµ­ íŒŒìš´ë“œ)" },
  { key: "ìœ ë¡œ", label: "EUR (ìœ ë¡œ)" },
  { key: "ì•„ëì—ë¯¸ë¦¬íŠ¸ë””ë¥´í•¨", label: "AED (ì•„ëì—ë¯¸ë¦¬íŠ¸ ë””ë¥´í•¨)" },
  { key: "ì¼ë³¸ì—”(100ì—”)", label: "JPY (ì¼ë³¸ì—”Â·100ì—”)" },
  { key: "ì¸ë„ë£¨í”¼", label: "INR (ì¸ë„ ë£¨í”¼)" }
];

// ìˆ«ì í¬ë§·
function formatNumber(x){
  if (x == null) return "-";
  const n = Number(x);
  return isNaN(n) ? "-" : n.toLocaleString("ko-KR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function parseNumber(x){
  const n = Number(String(x).replace(/,/g,""));
  return isNaN(n) ? null : n;
}

// ë‚ ì§œ ë³€í™˜
function ymdFromDate(d){
  return `${d.getFullYear()}${("0"+(d.getMonth()+1)).slice(-2)}${("0"+d.getDate()).slice(-2)}`;
}
function dateFromYmd(ymd){
  return new Date(ymd.slice(0,4), Number(ymd.slice(4,6))-1, ymd.slice(6,8));
}
function getYearStartYmd(ymd){
  return ymd.slice(0,4) + "0102";
}

// í‰ê·  ê³„ì‚°(ë‚ ì§œë³„ ìµœì´ˆê°’)
function calcAverage(rows, key, start, end){
  const map = {};
  rows.forEach(r=>{
    if (!String(r.ITEM_NAME1).includes(key)) return;
    const t = String(r.TIME);
    if (t < start || t > end) return;
    const v = parseNumber(r.DATA_VALUE);
    if (v == null) return;
    if (!(t in map)) map[t] = v;
  });
  const vals = Object.values(map);
  if (!vals.length) return null;
  return vals.reduce((a,b)=>a+b,0) / vals.length;
}

// ì¡°íšŒì¼ ìµœì´ˆê°’
function getRateOnDate(rows, key, ymd){
  let v = null;
  rows.forEach(r=>{
    if (!String(r.ITEM_NAME1).includes(key)) return;
    if (String(r.TIME) !== ymd) return;
    if (v == null) v = parseNumber(r.DATA_VALUE);
  });
  return v;
}

// ğŸ”¥ ì „ì¼(ì •í™•íˆ "ë°”ë¡œ ì´ì „ ì˜ì—…ì¼/ë°ì´í„° ì¡´ì¬ì¼") ìµœì´ˆê°’
function getPrevRateBeforeDate(rows, key, ymd){
  let prevDate = null;
  let prevVal = null;

  // rowsëŠ” ë³´í†µ TIME ì˜¤ë¦„/ë‚´ë¦¼ ì„ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ë‚ ì§œ ë¹„êµë¡œ ì°¾ê¸°
  rows.forEach(r=>{
    if (!String(r.ITEM_NAME1).includes(key)) return;
    const t = String(r.TIME || "");
    if (!t || t >= ymd) return;           // ì˜¤ëŠ˜ë³´ë‹¤ ì´ì „ë§Œ
    const v = parseNumber(r.DATA_VALUE);
    if (v == null) return;

    // ë‚ ì§œë³„ ìµœì´ˆê°’ë§Œ
    if (prevDate == null || t > prevDate){
      prevDate = t;
      prevVal = v;
    }
  });

  return { prevDate, prevVal };
}

let chartObj = null;

// ê·¸ë˜í”„
function updateChart(rows, queryYmd, label){
  const cfg = CURRENCIES.find(c=>c.label===label);
  if (!cfg) return;
  const key = cfg.key;

  const qd = dateFromYmd(queryYmd);
  const threeStart = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth()-3, 1));

  const map = {};
  rows.forEach(r=>{
    if (!String(r.ITEM_NAME1).includes(key)) return;
    const t = String(r.TIME);
    if (t < threeStart || t > queryYmd) return;
    const v = parseNumber(r.DATA_VALUE);
    if (v != null && !(t in map)) map[t] = v;
  });

  const dates = Object.keys(map).sort();
  const xLabels = dates.map(d => `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}`);
  const values = dates.map(d => map[d]);

  // ì „ì¼ëŒ€ë¹„ì— ë”°ë¼ ì„  ìƒ‰ ê²°ì •
  const today = getRateOnDate(rows, key, queryYmd);
  const { prevVal } = getPrevRateBeforeDate(rows, key, queryYmd);
  const delta = (today != null && prevVal != null) ? (today - prevVal) : 0;

  const lineColor = (delta > 0) ? "#A12A44" : (delta < 0) ? "#78787A" : "#000000";

  const ctx = document.getElementById("rateChart").getContext("2d");
  if (chartObj) chartObj.destroy();

  chartObj = new Chart(ctx, {
    type: "line",
    data: {
      labels: xLabels,
      datasets: [{
        data: values,
        borderColor: lineColor,
        borderWidth: 2,
        pointRadius: 0,
        fill: false,
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,  // ğŸ”¥ ì¹´ë“œ ë†’ì´ ë”°ë¼ê°
      plugins: { legend: { display: false } },
      layout: { padding: { top: 6, right: 6, bottom: 0, left: 6 } }, // âœ… ì „ì²´ ì—¬ë°± ì¤„ì„
      scales: {
        x: {
          grid: { drawBorder: false },
          ticks: { maxRotation: 0, autoSkip: true, padding: 2 }       // âœ… ì¶• ì—¬ë°± ì¤„ì„
        },
        y: {
          grid: { drawBorder: false },
          ticks: { padding: 2 },                                     // âœ… Yì¶• ì—¬ë°± ì¤„ì„
          grace: "1%"                                                // âœ… ìœ„/ì•„ë˜ ì—¬ë°±(ìë™) ìµœì†Œí™”
        }
      }
    }
  });
}

// ì „ì¼ëŒ€ë¹„ HTML
function deltaHtml(today, prev){
  if (today == null || prev == null) return ""; // ë°ì´í„° ë¶€ì¡±í•˜ë©´ í‘œì‹œ ì•ˆí•¨
  const diff = today - prev;

  if (Math.abs(diff) < 1e-9){
    return `<span class="delta same"><span class="badge">=</span>0.00</span>`;
  }

  const cls = diff > 0 ? "up" : "down";
  const arrow = diff > 0 ? "â–²" : "â–¼";
  return `<span class="delta ${cls}"><span class="badge">${arrow}</span>${formatNumber(Math.abs(diff))}</span>`;
}

// ì¡°íšŒ
function search(){
  $("#msg").removeClass("error").text("ì¡°íšŒì¤‘...");
  $("#tbody").empty();
  $("#subInfo").text("");

  const d = $("#dateInput").val();
  if (!d) return alert("ì¡°íšŒì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  const ymd = d.replace(/-/g,"");

  const qd = dateFromYmd(ymd);
  const yearStart = getYearStartYmd(ymd);

  const prevFirst = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth()-1, 1));
  const prevLast  = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth(), 0));
  const threeStart = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth()-3, 1));

  const minStart = (yearStart < threeStart ? yearStart : threeStart);
  const url = `${BACKEND}?start=${minStart}&end=${ymd}&callback=?`;

  $.ajax({
    url,
    dataType: "jsonp",
    success: function(data){
      $("#msg").text("");
      const rows = data?.StatisticSearch?.row || [];
      window._lastRows = rows;

      if (!rows.length){
        $("#msg").addClass("error").text("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ê³µíœ´ì¼/ì£¼ë§ ë“±)");
        return;
      }

      $("#subInfo").text(`ì¡°íšŒ ê¸°ì¤€ì¼: ${d}`);
      $("#tbody").empty();

      CURRENCIES.forEach(c=>{
        const today = getRateOnDate(rows, c.key, ymd);
        const { prevVal } = getPrevRateBeforeDate(rows, c.key, ymd);

        const yavg  = calcAverage(rows, c.key, yearStart, ymd);
        const pavg  = calcAverage(rows, c.key, prevFirst, prevLast);
        const m3avg = calcAverage(rows, c.key, threeStart, prevLast);

        $("#tbody").append(`
          <tr>
            <td>${c.label}</td>
            <td>
              ${formatNumber(today)}
              ${deltaHtml(today, prevVal)}
            </td>
            <td>${formatNumber(yavg)}</td>
            <td>${formatNumber(pavg)}</td>
            <td>${formatNumber(m3avg)}</td>
          </tr>
        `);
      });

      // ê·¸ë˜í”„ ì´ˆê¸° í†µí™”
      const selected = $("#chartCurrency").val() || CURRENCIES[0].label;
      updateChart(rows, ymd, selected);
    },
    error: function(){
      $("#msg").addClass("error").text("ì¡°íšŒ ì˜¤ë¥˜: ë°±ì—”ë“œ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
  });
}

// CSV ë‹¤ìš´ë¡œë“œ
function downloadCSV(){
  let lines = ["í†µí™”,ìµœì´ˆ ê³ ì‹œí™˜ìœ¨,ì—°ì´ˆ~ì¡°íšŒì¼ í‰ê· ,ì „ì›” í‰ê· ,ìµœê·¼ 3ê°œì›” í‰ê· "];
  $("#tbody tr").each(function(){
    const tds = $(this).find("td");
    const arr = [];
    tds.each(function(){
      // ì „ì¼ëŒ€ë¹„(â–²/â–¼) í…ìŠ¤íŠ¸ë„ ê°™ì´ ì„ì¼ ìˆ˜ ìˆì–´ ìˆ«ìë§Œ ë‚¨ê¸°ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬ ê°€ëŠ¥
      arr.push($(this).text().replace(/,/g,"").replace(/\s+/g," ").trim());
    });
    lines.push(arr.join(","));
  });

  const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "í™˜ìœ¨ì¡°íšŒ.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ì´ˆê¸° ì‹¤í–‰
$(function(){
  const t = new Date();
  $("#dateInput").val(`${t.getFullYear()}-${("0"+(t.getMonth()+1)).slice(-2)}-${("0"+t.getDate()).slice(-2)}`);

  CURRENCIES.forEach(c=>{
    $("#chartCurrency").append(`<option value="${c.label}">${c.label}</option>`);
  });

  $("#btnSearch").on("click", search);
  $("#btnCsv").on("click", downloadCSV);

  $("#chartCurrency").on("change", function(){
    if (!window._lastRows) return;
    const d = $("#dateInput").val().replace(/-/g,"");
    updateChart(window._lastRows, d, $(this).val());
  });

  // ì²« í™”ë©´ ìë™ ì¡°íšŒ
  search();
});
</script>

</body>
</html>
