<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>환율 조회 (한국은행 ECOS · 매매기준율 기준)</title>

<!-- jQuery & Chart.js -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ✅ Excel(.xlsx) 다운로드용 SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* ===== 전체 레이아웃 ===== */
body {
  font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
  background: #f7f7f7;
  margin: 0;
  padding: 0;
  color: #333;
}

/* ===== 상단 헤더 ===== */
.header {
  display: flex;
  align-items: center;
  padding: 22px 32px;
  background: #ffffff;
  border-bottom: 1px solid #eee;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

.header img { height: 34px; margin-right: 14px; }

.header-title {
  font-size: 22px;
  font-weight: 600;
  color: #A12A44; /* Infinite Burgundy */
  margin-left: 8px;
}

.header-title .source {
  font-size: 14px;
  font-weight: 400;
  color: #888;
  margin-left: 8px;
}

/* ===== 조회 카드 ===== */
.card {
  background: #fff;
  border-radius: 14px;
  padding: 22px 28px;
  margin: 24px auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

/* ===== 조회 영역 ===== */
#dateInput {
  padding: 6px 10px;
  font-size: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

button {
  background: #A12A44;
  color: #fff;
  border: none;
  padding: 8px 16px;
  font-size: 15px;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.15s;
  margin-left: 6px;
}
button:hover { background: #8B233A; }

/* ===== 테이블 ===== */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  background: #fff;
}

th {
  background: #F4E6EA;
  color: #A12A44;
  font-weight: 600;
  padding: 14px 0;
  border-bottom: 2px solid #ddd;
  text-align: center;
}
td {
  padding: 12px 6px;
  border-bottom: 1px solid #eee;
  text-align: center;
}
tbody tr:hover { background: #fafafa; }

/* ===== 안내문구 ===== */
.info { font-size: 13px; color: #555; margin-top: 10px; }
.error { color: #d00; font-weight: bold; margin-top: 12px; }

/* ===== 그래프 영역 ===== */
#chartArea { margin-top: 36px; }
#chartContainer { max-width: 900px; margin: 0 auto; }
#rateChart {
  background: #ffffff;
  border-radius: 14px;
  padding: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
select {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #aaa;
  font-size: 15px;
}
</style>
</head>

<body>

<div class="header">
  <img src="Suprema_logo_basic.jpg" alt="Suprema Logo">
  <div class="header-title">
    환율 조회 <span class="source">(한국은행 ECOS)</span>
  </div>
</div>

<div class="card">
  <label>조회일:
    <input type="date" id="dateInput">
  </label>
  <button id="btnSearch">조회</button>
  <button id="btnExcel">엑셀 내려받기</button>

  <div id="msg"></div>
  <div id="subInfo" class="info"></div>
</div>

<div class="card">
  <table>
    <thead>
      <tr>
        <th>통화</th>
        <th>최초 고시환율 (원)</th>
        <th>연초~조회일 평균 (원)</th>
        <th>전월 평균 (원)</th>
        <th>최근 3개월 평균 (원)</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="card" id="chartArea">
  <h3>환율 변동 추이 (최근 3개월)</h3>
  <label>통화:
    <select id="chartCurrency"></select>
  </label>

  <div id="chartContainer">
    <canvas id="rateChart" height="260"></canvas>
  </div>
</div>

<script>
// 백엔드 웹앱 주소
const BACKEND =
  "https://script.google.com/macros/s/AKfycbwy_VgzLTGEoc_Cww9lQ4_44GZHsWRbEKJvYN6SByvXS13qV0LPEYgPjuSWuiJKTEZm/exec";

// ECOS 통화 목록
const CURRENCIES = [
  { key: "미국달러", label: "USD (미국 달러)" },
  { key: "멕시코", label: "MXN (멕시코 페소)" },
  { key: "영국파운드", label: "GBP (영국 파운드)" },
  { key: "유로", label: "EUR (유로)" },
  { key: "아랍에미리트디르함", label: "AED (아랍에미리트 디르함)" },
  { key: "일본엔(100엔)", label: "JPY (일본엔·100엔)" },
  { key: "인도루피", label: "INR (인도 루피)" }
];

function formatNumber(x) {
  if (x == null) return "-";
  const n = Number(x);
  return isNaN(n) ? "-" :
    n.toLocaleString("ko-KR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function parseNumber(x) {
  const n = Number(String(x).replace(/,/g, ""));
  return isNaN(n) ? null : n;
}
function ymdFromDate(d) {
  return `${d.getFullYear()}${("0" + (d.getMonth() + 1)).slice(-2)}${("0" + d.getDate()).slice(-2)}`;
}
function dateFromYmd(ymd) {
  return new Date(ymd.slice(0, 4), ymd.slice(4, 6) - 1, ymd.slice(6, 8));
}
function getYearStartYmd(ymd) {
  return ymd.slice(0, 4) + "0102";
}

function calcAverage(rows, key, start, end) {
  const map = {};
  rows.forEach(r => {
    if (!String(r.ITEM_NAME1).includes(key)) return;
    const t = String(r.TIME);
    if (t < start || t > end) return;
    const v = parseNumber(r.DATA_VALUE);
    if (v == null) return;
    if (!(t in map)) map[t] = v;
  });
  const vals = Object.values(map);
  if (!vals.length) return null;
  return vals.reduce((a, b) => a + b, 0) / vals.length;
}
function getRateOnDate(rows, key, ymd) {
  let v = null;
  rows.forEach(r => {
    if (!String(r.ITEM_NAME1).includes(key)) return;
    if (String(r.TIME) !== ymd) return;
    if (v == null) v = parseNumber(r.DATA_VALUE);
  });
  return v;
}

// ===== 그래프 =====
function updateChart(rows, queryYmd, label) {
  const cfg = CURRENCIES.find(c => c.label === label);
  if (!cfg) return;
  const key = cfg.key;

  const qd = dateFromYmd(queryYmd);
  const threeStart = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth() - 3, 1));

  const map = {};
  rows.forEach(r => {
    if (!String(r.ITEM_NAME1).includes(key)) return;
    const t = String(r.TIME);
    if (t < threeStart || t > queryYmd) return;
    const v = parseNumber(r.DATA_VALUE);
    if (v != null && !(t in map)) map[t] = v;
  });

  const dates = Object.keys(map).sort();
  const labels = dates.map(d => `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}`);
  const values = dates.map(d => map[d]);

  const ctx = document.getElementById("rateChart").getContext("2d");
  if (window._chartObj) window._chartObj.destroy();

  window._chartObj = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label,
        data: values,
        borderColor: "#78787A",
        borderWidth: 2,
        pointRadius: 0,
        fill: false,
        tension: 0.2
      }]
    },
    options: {
      plugins: { legend: { display: false } }
    }
  });
}

// ===== 조회 =====
function search() {
  $("#msg").text("조회중...");
  $("#tbody").empty();

  const d = $("#dateInput").val();
  if (!d) return alert("조회일을 입력해주세요.");
  const ymd = d.replace(/-/g, "");

  const qd = dateFromYmd(ymd);
  const yearStart = getYearStartYmd(ymd);

  const prevFirst = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth() - 1, 1));
  const prevLast  = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth(), 0));
  const threeStart = ymdFromDate(new Date(qd.getFullYear(), qd.getMonth() - 3, 1));

  const minStart = (yearStart < threeStart ? yearStart : threeStart);
  const url = `${BACKEND}?start=${minStart}&end=${ymd}&callback=?`;

  $.ajax({
    url,
    dataType: "jsonp",
    success: function (data) {
      $("#msg").text("");

      const rows = data?.StatisticSearch?.row || [];
      window._lastRows = rows;

      if (!rows.length) {
        $("#msg").addClass("error").text("데이터가 없습니다. (공휴일/주말 등)");
        return;
      }

      $("#tbody").empty();

      CURRENCIES.forEach(c => {
        const fr   = getRateOnDate(rows, c.key, ymd);
        const yavg = calcAverage(rows, c.key, yearStart, ymd);
        const pavg = calcAverage(rows, c.key, prevFirst, prevLast);
        const m3avg= calcAverage(rows, c.key, threeStart, prevLast);

        $("#tbody").append(`
          <tr>
            <td>${c.label}</td>
            <td>${formatNumber(fr)}</td>
            <td>${formatNumber(yavg)}</td>
            <td>${formatNumber(pavg)}</td>
            <td>${formatNumber(m3avg)}</td>
          </tr>
        `);
      });

      $("#subInfo").text(`조회 기준일: ${d}`);

      updateChart(rows, ymd, $("#chartCurrency").val());
    },
    error: function () {
      $("#msg").addClass("error").text("데이터 로드 실패(JSONP).");
    }
  });
}

// ✅ 엑셀(.xlsx) 내려받기 — 테이블 그대로 저장
function downloadExcel() {
  const header = [];
  $("table thead th").each(function() {
    header.push($(this).text().trim());
  });

  const data = [header];

  $("#tbody tr").each(function () {
    const row = [];
    $(this).find("td").each(function () {
      row.push($(this).text().trim());
    });
    data.push(row);
  });

  if (data.length <= 1) {
    alert("먼저 조회를 눌러 데이터를 불러온 후 다운로드 해주세요.");
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);

  // 보기 좋게 컬럼 너비
  ws["!cols"] = [
    { wch: 18 },
    { wch: 18 },
    { wch: 18 },
    { wch: 16 },
    { wch: 18 }
  ];

  XLSX.utils.book_append_sheet(wb, ws, "환율");

  const filename = `환율조회_${$("#dateInput").val() || "today"}.xlsx`;
  XLSX.writeFile(wb, filename);
}

$(function () {
  const t = new Date();
  $("#dateInput").val(
    `${t.getFullYear()}-${("0" + (t.getMonth() + 1)).slice(-2)}-${("0" + t.getDate()).slice(-2)}`
  );

  CURRENCIES.forEach(c =>
    $("#chartCurrency").append(`<option value="${c.label}">${c.label}</option>`)
  );

  $("#btnSearch").on("click", search);
  $("#btnExcel").on("click", downloadExcel);

  $("#chartCurrency").on("change", function () {
    if (!window._lastRows) return;
    const d = $("#dateInput").val().replace(/-/g, "");
    updateChart(window._lastRows, d, $(this).val());
  });

  // 첫 화면 자동 조회
  search();
});
</script>

</body>
</html>





