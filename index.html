<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>슈프리마 달러 환율 조회 시스템</title>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --burgundy:#A12A44;
  --burgundy-dark:#8B233A;
  --burgundy-light:#F4E6EA;
  --bg:#f7f7f7;
  --card:#ffffff;
  --border:#e0e0e0;
  --text-gray:#666;
  --shadow:0 4px 12px rgba(0,0,0,0.08);
}
*{ box-sizing:border-box; }
body{ font-family:'Pretendard', sans-serif; background:var(--bg); margin:0; color:#333; }

/* 헤더 */
.header{ display:flex; align-items:center; gap:14px; padding:18px 24px; background:#fff; border-bottom:1px solid var(--border); }
.header img{ height:34px; }
.header-title .title{ font-size:22px; font-weight:800; color:var(--burgundy); }

.container{ width:100%; padding:14px; max-width: 1200px; margin: 0 auto; }
.card{ background:var(--card); border-radius:14px; padding:20px; box-shadow:var(--shadow); margin-bottom:14px; border:1px solid var(--border); }

/* 컨트롤 박스 */
.topbar{ display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; }
.controls{ display:flex; align-items:center; gap:10px; }
select, input[type="date"] { padding:8px 12px; border-radius:8px; border:1px solid #ccc; font-size:15px; outline: none; }
button{ background:var(--burgundy); color:#fff; border:none; padding:8px 20px; border-radius:8px; cursor:pointer; font-size:15px; font-weight: 600; }
button:hover{ background:var(--burgundy-dark); }

/* 메인 그리드 */
.grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
@media (max-width: 850px){ .grid{ grid-template-columns: 1fr; } }

/* 테이블 스타일 */
.table-wrap{ overflow:auto; border-radius:12px; border:1px solid var(--border); }
table{ width:100%; border-collapse:collapse; }
th{ background:var(--burgundy-light); color:var(--burgundy); padding:15px; border-bottom:2px solid var(--border); font-weight:800; }
td{ padding:15px; border-bottom:1px solid var(--border); text-align:center; font-size: 16px; }

/* 슈프리마 강조 스타일 */
.suprema-label { font-size: 18px; font-weight: 900; color: var(--burgundy); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
.highlight-row { background-color: #fcfcfc; }
.val-primary { font-size: 20px; font-weight: 800; color: var(--burgundy); }
.val-sub { color: #333; font-weight: 700; }

.chart-box{ position:relative; height:350px; border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; }
.loading-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; align-items:center; justify-content:center; z-index:10; border-radius:14px; font-weight: 700; color: var(--burgundy); }
</style>
</head>

<body>
  <div class="header">
    <img src="Suprema_logo_basic.jpg" alt="Logo">
    <div class="header-title"><div class="title">슈프리마 달러(USD) 환율 관리 시스템</div></div>
  </div>

  <div class="container">
    <div class="card">
      <div class="topbar">
        <div class="controls">
          <span style="font-weight: 700;">적용 월 조회:</span>
          <select id="selectYear"></select>
          <select id="selectMonth"></select>
          <button id="btnSearch">조회하기</button>
        </div>
        <div id="infoText" style="font-size:13px; color:var(--text-gray);">데이터를 불러오는 중입니다...</div>
      </div>
    </div>

    <div class="grid">
      <div class="card" style="position:relative;">
        <div id="loader" class="loading-overlay">데이터 분석 중...</div>
        <div class="suprema-label">※ 슈프리마 적용환율 (USD)</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>구분</th>
                <th>금액 (원)</th>
              </tr>
            </thead>
            <tbody id="supremaResult">
              <tr><td colspan="2" style="padding:40px; color:#999;">조회 버튼을 눌러주세요.</td></tr>
            </tbody>
          </table>
        </div>
        <p style="font-size: 12px; color: #888; margin-top: 15px;">
          * 원가: 전월 평균과 직전 3개월 평균 중 큰 값(MAX) 적용<br>
          * 판가: 원가에서 50원 차감한 금액
        </p>
      </div>

      <div class="card">
        <div class="suprema-label">USD 환율 변동 추이</div>
        <div class="chart-box"><canvas id="usdChart"></canvas></div>
      </div>
    </div>
    
    <div class="card">
        <div class="suprema-label">상세 분석 데이터</div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>조회 대상월</th>
                        <th>전월 평균 (A)</th>
                        <th>직전 3개월 평균 (B)</th>
                        <th>평균 대비 편차</th>
                    </tr>
                </thead>
                <tbody id="detailTable"></tbody>
            </table>
        </div>
    </div>
  </div>

<script>
const BACKEND = "https://script.google.com/macros/s/AKfycbwy_VgzLTGEoc_Cww9lQ4_44GZHsWRbEKJvYN6SByvXS13qV0LPEYgPjuSWuiJKTEZm/exec";
let globalRows = [];

// 숫자 포맷
function fNum(x, f=2){ return x == null ? "-" : Number(x).toLocaleString("ko-KR",{minimumFractionDigits:f, maximumFractionDigits:f}); }
function pNum(x){ return isNaN(parseFloat(String(x).replace(/,/g,""))) ? null : parseFloat(String(x).replace(/,/g,"")); }
function toYmd(d){ return d.getFullYear() + ("0"+(d.getMonth()+1)).slice(-2) + ("0"+d.getDate()).slice(-2); }

// 초기 설정
$(function(){
    const now = new Date();
    for(let y=now.getFullYear(); y>=now.getFullYear()-1; y--) $("#selectYear").append(`<option value="${y}">${y}년</option>`);
    for(let m=1; m<=12; m++) {
        let sel = (m === now.getMonth()+1) ? "selected" : "";
        $("#selectMonth").append(`<option value="${m}" ${sel}>${m}월</option>`);
    }
    
    $("#btnSearch").on("click", loadData);
    loadData(); // 최초 자동 실행
});

function loadData(){
    const year = $("#selectYear").val();
    const month = $("#selectMonth").val();
    const startYmd = (year - 1) + "0101"; // 연간 데이터 확보
    const endYmd = year + ("0"+month).slice(-2) + "31";

    $("#loader").css("display", "flex");
    
    $.ajax({
        url: `${BACKEND}?start=${startYmd}&end=${endYmd}&callback=?`,
        dataType: "jsonp",
        success: function(data){
            $("#loader").hide();
            globalRows = (data?.StatisticSearch?.row || []).filter(r => r.ITEM_NAME1.includes("미국달러"));
            if(!globalRows.length) { alert("데이터를 찾을 수 없습니다."); return; }
            calculateSuprema(year, month);
        }
    });
}

function calculateSuprema(year, month){
    const targetYm = year + ("0" + month).slice(-2);
    
    // A: 전월 평균 (조회월의 전달)
    const d1_start = toYmd(new Date(year, month - 2, 1));
    const d1_end = toYmd(new Date(year, month - 1, 0));
    const pavg = calcAvg(d1_start, d1_end);

    // B: 직전 3개월 평균
    const d3_start = toYmd(new Date(year, month - 4, 1));
    const d3_end = d1_end;
    const m3avg = calcAvg(d3_start, d3_end);

    if(pavg && m3avg) {
        const wonka = Math.max(pavg, m3avg);
        const panka = wonka - 50;

        // 결과 출력
        $("#supremaResult").html(`
            <tr class="highlight-row"><td>전월 평균 환율 (A)</td><td>${fNum(pavg)} 원</td></tr>
            <tr class="highlight-row"><td>직전 3개월 평균 (B)</td><td>${fNum(m3avg)} 원</td></tr>
            <tr style="background:var(--burgundy-light)"><td><strong>최종 원가 (MAX)</strong></td><td class="val-primary">${fNum(wonka)} 원</td></tr>
            <tr><td><strong>최종 판가 (원가-50)</strong></td><td class="val-sub">${fNum(panka)} 원</td></tr>
        `);

        $("#detailTable").html(`
            <tr>
                <td>${year}년 ${month}월</td>
                <td>${fNum(pavg)} 원</td>
                <td>${fNum(m3avg)} 원</td>
                <td>${fNum(pavg - m3avg)} 원</td>
            </tr>
        `);

        $("#infoText").text(`${year}년 ${month}월 기준 USD 환율 분석 완료`);
        updateUsdChart(year, month);
    } else {
        $("#supremaResult").html(`<tr><td colspan="2" style="padding:40px; color:red;">해당 기간의 평균 데이터를 산출할 수 없습니다.</td></tr>`);
    }
}

function calcAvg(s, e){
    const v = globalRows.filter(r => r.TIME >= s && r.TIME <= e).map(r => pNum(r.DATA_VALUE)).filter(n => n != null);
    return v.length ? v.reduce((a,b) => a+b, 0) / v.length : null;
}

function updateUsdChart(year, month){
    const end = toYmd(new Date(year, month, 0));
    const start = toYmd(new Date(year, month-4, 1));
    const cRows = globalRows.filter(r => r.TIME >= start && r.TIME <= end).sort((a,b) => a.TIME.localeCompare(b.TIME));

    const dates = cRows.map(r => r.TIME);
    const values = cRows.map(r => pNum(r.DATA_VALUE));

    const ctx = document.getElementById("usdChart").getContext("2d");
    if (window._chart) window._chart.destroy();

    window._chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: dates,
            datasets: [{
                label: 'USD 환율',
                data: values,
                borderColor: "#A12A44",
                backgroundColor: "rgba(161, 42, 68, 0.1)",
                fill: true,
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { callback: (v, i) => i % 15 === 0 ? dates[i].slice(4,6)+"/"+dates[i].slice(6,8) : null } }
            }
        }
    });
}
</script>
</body>
</html>




